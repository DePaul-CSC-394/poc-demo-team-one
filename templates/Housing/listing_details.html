{% extends 'base.html' %}
{% load static %}

{% block content %}
{% block hero %}{% endblock %}

    <div>
        {% if listing %}
            <div class="image-row">
                <img src={{listing.photo_1}} alt="Example Image">
                <img src={{listing.photo_2}} alt="Example Image">
            </div>
            <div class="details-row mt-3">
                <div class="info-block">
                    <p>{{listing.description}}</p>
                </div>
                <div class='right-block'>
                    <div class="info-col">
                        <div class="icon-val">
                            <div class="icon-col">
                                <i class="fa-solid fa-ruler-combined"></i>
                                <i class="fa-solid fa-dollar-sign"></i>
                                <i class="fa-solid fa-house"></i>
                            </div>
                            <div class="data-col">
                                <p>{{listing.sqFeet}} Sq. Feet</p>
                                <p>{{listing.price}}</p>
                                <p>{{listing.home_type}}</p>
                            </div>
                        </div>
                        
                        <div class="booking-section">
                            <label for="checkin">Check-in:</label>
                            <input type="date" id="checkin" required>

                            <label for="checkout">Check-out:</label>
                            <input type="date" id="checkout" required>
                        
                            <button id="book-btn" class="btn btn-secondary book-btn">Book</button>
                        </div>
                    <div class="map">
                        {{ map_html|safe }}
                    </div>
                </div>
            </div>
        {% endif %}
    </div>

    <script>
        document.getElementById("book-btn").addEventListener("click", function(event) {
            const checkin = document.getElementById("checkin").value;
            const checkout = document.getElementById("checkout").value;
        
            if (!checkin || !checkout) {
                alert("Please select check-in and check-out dates.");
                return;
            }
        
            const listingId = "{{ listing.id }}";  
            fetch(`/create-checkout-session/${listingId}/?checkin=${checkin}&checkout=${checkout}`)
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(error => { throw new Error(error.error); });
                    }
                    return response;
                })
                .then(() => {
                    window.location.href = `/create-checkout-session/${listingId}/?checkin=${checkin}&checkout=${checkout}`;
                })
                .catch(error => {
                    alert(error.message);  // Show error message to the user
                });
        });
        </script>

{% endblock %}

{% block extrastyle %}
    <link rel="stylesheet" href="{%static 'css/listing_details.css' %}" />
{% endblock %}